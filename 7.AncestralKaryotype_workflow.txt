###Workflow for Ancestral Karyotype Reconstruction###

###Reciprocal BLASTP for homolog search among all species pairs###
###alternatively, you can use DIAMOND for accelerated homology search####
#diamond makedb --in species1.pep -d species.pep.db
#diamond blastp  -q species1.pep -d species2.pep.db -o species1-species2.blastout --evalue 1E-5  --threads 8 --max-target-seqs 6 -outfmt 0
makeblastdb -in species2.pep  -dbtype prot -out species2.pep.db
blastp -query species1.pep -db species2.pep.db -num_threads 12 -evalue 1E-5 -max-target-seqs 6 -outfmt 0 -out species1-species2.blastout


###Use CIP and CALP (>=50%) as threshold parameters to obtain conserved orthologs##
###see details in Jerome Salse et al., Improved criteria and comparative genomics tool provide new insights into grass paleogenomics, Briefings in Bioinformatics, Volume 10, Issue 6, November 2009, Pages 619â€“630, https://doi.org/10.1093/bib/bbp037 ####
###alternatively, use perl script to filter your blast output###
###https://github.com/nelumbolutea/amk_article/blob/main/6.CIP_CALP.pl ####
perl 6.CIP_CALP.pl species1-species2.blastout >species1-species2.blastout

###Obtain one-to-one conserved orthologs#####
###identify and remove tandemly duplicated loci from reciprocal blast gene pairs### 
###coordinate_file.gff and tabular-format.blastout are required###
###alternatively use tools such as McScanX for tandem loci detection###
###https://github.com/wyp1125/MCScanX #########
###removing tandem loci in 'species1_species2.tandem'for downstream SBs search##
./MCScanX species1_species2

###Build Syntenic blocks (SBs) among species using one-to-one conserved orthologs###
###alternatively, use DRIMM-synteny####
###http://grimm.ucsd.edu/DIST/ ###
###sharing more than 5 orthologous genes with '-m 6'###
###install DRIMM-synteny###
wget http://grimm.ucsd.edu/DIST/GRIMM_SYNTENY-2.02.zip
unzip GRIMM_SYNTENY-2.02.zip
cd GRIMM_SYNTENY-2.02
sudo make
###preparing a file 'one-to-one_coords.txt' containing gene coordinates for one-to-one conserved orthologs among all investigated species## 
###example coordinate format can be found in '~/GRIMM_SYNTENY-2.02/data/hmrc_gene_data/hmrc_genes_ensembl.txt' ###
mkdir MRCA_SB
./grimm_synt -f one-to-one_coords.txt -d MRCA -m 6
###Arrangement of SBs on chromosomes of each species in 'grimm format' can be found in path '~/GRIMM_SYNTENY-2.02/MRCA_SB/mgr_macro.txt'##


###Merge SBs into CARs (protochromosomes)###
#####alternatively using tools such as MGRA###
###https://github.com/compbiol/mgra ###
##to install mgra, make sure CMAKE, gcc, git were installed###
git clone https://github.com/compbiol/mgra.git
cd mgra
sudo mkdir build
cd build
sudo cmake ../
sudo make
sudo make install
###Note:change file paths in cmake_install.cmake when errors produced by 'sudo make install'###
###preparing a config file 'MRCA.cfg' containing both species name list and newick format species tree such as '(A,(D,(B,C)))MRCA'###
###MRCA aka. Most Recent Common Ancestor###
###example of config file can be referred to '~/mgra/examples/mam6/sim.cfg'
###A grimm format file 'mgr_macro.txt' with sytenic blocks (SBs) on species chromosomes is obtained from GRIMM-synteny ###
mkdir MRCA_CARs
mgra -c MRCA.cfg -g mgr_macro.txt -o MRCA_CARs
###Linear arrangement of SBs on MRCA chromosomes (ancestral karyotype, CARs) can be found in '~/mgra/MRCA_CARs/genomes/MRCA.gen'###


###Dotplot validations of MRCA CARs aligning to modern species chromosomes can be obtained such as tools JCVI###
###https://github.com/tanghaibao/jcvi ####
python -m jcvi.graphics.dotplot MRCA.species1.anchors

###Summarize the minimum fissions and fusions of SBs from 'MRCA.gen' CARs into descendant species chromosomes following parsimony model###
##see Supplementary Table S5,Supplementary Figure S15###